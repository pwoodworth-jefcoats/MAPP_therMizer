---
title: "Prep_Plankton_therMizer"
author: "Phoebe.Woodworth-Jefcoats@noaa.gov"
date: '2024-01-19'
output: html_document
---

## Prep plankton forcing for input into therMizer

This script uses the files output by Plankton_ts.jnl (for use with [PyFerret](https://ferret.pmel.noaa.gov/Ferret/)) to create the background resource array that will be used by therMizer.  In that script, plankton carbon densities were converted to total carbon and summed over the model domain.  This is similar to, but an improvement upon, [Woodworth-Jefcoats et al. 2019](https://www.frontiersin.org/articles/10.3389/fmars.2019.00383/full).  Here, this total carbon is used to create resource spectra at each time step.

Size class ranges, for reference (ESD = Equivalent Spherical Diameter):  
- Small phytoplankton = 0.5 - 20 um ESD (mid-point size = 10.25 um ESD)
- Diatoms = 20 - 200 um ESD (mid-point size = 110 um ESD)
- Diazotrophs = 20 - 200 um ESD (mid-point size = 110 um ESD)
- Zooplankton = 2 - 20000 um ESD (mid-point size = 10001 um ESD)

These size classes were informed by:
Long et al. [2021](https://doi.
org/10.1029/2021MS002647) for the min and max plankton sizes, 
Woodworth-Jefcoats et al. [2019](https://www.frontiersin.org/articles/10.3389/fmars.2019.00383/full) for the cut-offs between size classes, and
Kearney et al. [2021](https://doi.org/10.3389/fmars.2021.622206) as an indispensable background reference.

Conversions used:  
- Convert g C to gww --> $\times 10$  
- Convert um ESD to gww --> $\frac{4}{3}\pi(0.5\times0.0001\times size)^3$

```{r}
# Load libraries
library(tidyverse)
library(here)
```

```{r}
# Create variables for referencing the size class mid points, in gww
small_mid <- (4/3)*pi*((0.5*0.0001*10.25)^3)
large_mid <- (4/3)*pi*((0.5*0.0001*110)^3)
zoo_mid <- (4/3)*pi*((0.5*0.0001*10001)^3)

# Combine mid-point sizes for generating the x-axis for the linear fit
plankton_x <- log10(c(small_mid, large_mid, zoo_mid))

# Create arrays for output and fill them in the loop below
out_LENS <- array(numeric(), c(86,226,10)) # 600 time steps by 226 size classes by 10 ensemble members
LENS_slope <- array(numeric(), c(86,1,10)) # 600 time steps by 10 ensemble members
LENS_intercept <- array(numeric(), c(86,1,10)) # 600 time steps by 10 ensemble members

# Load total carbon data, skipping the 7-line header
# There are 10 ensemble members, so we're going to combine things for efficiency
for (m in seq(1,10,1)) {
  if (m < 10) {
    LENS_small <- read.table(here("ClimateForcing", "Plankton", "DataFiles",
                              paste("LE2_00", m, "_intspC_sum.dat", sep = "")),
                              skip = 7, header = FALSE)
    LENS_diat <- read.table(here("ClimateForcing", "Plankton", "DataFiles",
                              paste("LE2_00", m, "_intdiatC_sum.dat", sep = "")),
                              skip = 7, header = FALSE)
    LENS_diaz <- read.table(here("ClimateForcing", "Plankton", "DataFiles",
                              paste("LE2_00", m, "_intdiazC_sum.dat", sep = "")),
                              skip = 7, header = FALSE)
    LENS_zoo <- read.table(here("ClimateForcing", "Plankton", "DataFiles",
                              paste("LE2_00", m, "_intzooC_sum.dat", sep = "")),
                              skip = 7, header = FALSE)
  } else {
    LENS_small <- read.table(here("ClimateForcing", "Plankton", "DataFiles",
                              paste("LE2_0", m, "_intspC_sum.dat", sep = "")),
                              skip = 7, header = FALSE)
    LENS_diat <- read.table(here("ClimateForcing", "Plankton", "DataFiles",
                              paste("LE2_0", m, "_intdiatC_sum.dat", sep = "")),
                              skip = 7, header = FALSE)
    LENS_diaz <- read.table(here("ClimateForcing", "Plankton", "DataFiles",
                              paste("LE2_0", m, "_intdiazC_sum.dat", sep = "")),
                              skip = 7, header = FALSE)
    LENS_zoo <- read.table(here("ClimateForcing", "Plankton", "DataFiles",
                              paste("LE2_0", m, "_intzooC_sum.dat", sep = "")),
                              skip = 7, header = FALSE)
  }
  
  # Convert total carbon to gww and then get numerical abundance by dividing by size class mid point
  # This step assumes that all plankton are the midpoint size
  small_abund <- LENS_small[,3]*10/small_mid
  large_abund <- (LENS_diat[,3] + LENS_diaz[,3])*10/large_mid
  zoo_abund <- LENS_zoo[,3]*10/zoo_mid
  
  # The full spectrum sizes were generated by setting up a mizer params:
  # params <- newMultispeciesParams(HIparams, interaction = HIinter, kappa = 1e12, min_w_pp = 1e-14)
  # and accessing the full size range
  # log10(params@w_full)
  full_x <- c(-14.01977294, -13.93231443, -13.84485591, -13.75739740, -13.66993888, -13.58248037, -13.49502185, -13.40756333, -13.32010482, -13.23264630, -13.14518779, -13.05772927, -12.97027076, -12.88281224, -12.79535373, -12.70789521, -12.62043670, -12.53297818, -12.44551967, -12.35806115, -12.27060263, -12.18314412, -12.09568560, -12.00822709, -11.92076857, -11.83331006, -11.74585154, -11.65839303, -11.57093451, -11.48347600, -11.39601748, -11.30855896, -11.22110045, -11.13364193, -11.04618342, -10.95872490, -10.87126639, -10.78380787, -10.69634936, -10.60889084, -10.52143233, -10.43397381, -10.34651530, -10.25905678, -10.17159826, -10.08413975, -9.99668123,  -9.90922272, -9.82176420, -9.73430569, -9.64684717, -9.55938866, -9.47193014, -9.38447163, -9.29701311, -9.20955459, -9.12209608, -9.03463756, -8.94717905, -8.85972053, -8.77226202, -8.68480350, -8.59734499, -8.50988647, -8.42242796, -8.33496944, -8.24751093, -8.16005241, -8.07259389, -7.98513538, -7.89767686, -7.81021835, -7.72275983, -7.63530132, -7.54784280, -7.46038429, -7.37292577, -7.28546726, -7.19800874, -7.11055022, -7.02309171, -6.93563319, -6.84817468, -6.76071616, -6.67325765, -6.58579913, -6.49834062, -6.41088210, -6.32342359, -6.23596507, -6.14850656, -6.06104804, -5.97358952, -5.88613101, -5.79867249, -5.71121398, -5.62375546, -5.53629695, -5.44883843, -5.36137992, -5.27392140, -5.18646289, -5.09900437, -5.01154585, -4.92408734, -4.83662882, -4.74917031, -4.66171179, -4.57425328, -4.48679476, -4.39933625, -4.31187773, -4.22441922, -4.13696070, -4.04950219, -3.96204367, -3.87458515, -3.78712664, -3.69966812, -3.61220961, -3.52475109, -3.43729258, -3.34983406, -3.26237555, -3.17491703, -3.08745852, -3.00000000, -2.91254148, -2.82508297, -2.73762445, -2.65016594, -2.56270742, -2.47524891, -2.38779039, -2.30033188, -2.21287336, -2.12541485, -2.03795633, -1.95049781, -1.86303930, -1.77558078, -1.68812227, -1.60066375, -1.51320524, -1.42574672, -1.33828821, -1.25082969, -1.16337118, -1.07591266, -0.98845415, -0.90099563, -0.81353711, -0.72607860, -0.63862008, -0.55116157, -0.46370305, -0.37624454, -0.28878602, -0.20132751, -0.11386899, -0.02641048,  0.06104804, 0.14850656, 0.23596507, 0.32342359, 0.41088210, 0.49834062, 0.58579913, 0.67325765, 0.76071616, 0.84817468, 0.93563319, 1.02309171, 1.11055022, 1.19800874, 1.28546726, 1.37292577, 1.46038429, 1.54784280, 1.63530132, 1.72275983, 1.81021835, 1.89767686, 1.98513538, 2.07259389, 2.16005241, 2.24751093, 2.33496944, 2.42242796, 2.50988647, 2.59734499, 2.68480350, 2.77226202, 2.85972053, 2.94717905, 3.03463756, 3.12209608, 3.20955459, 3.29701311, 3.38447163, 3.47193014, 3.55938866, 3.64684717, 3.73430569, 3.82176420, 3.90922272, 3.99668123, 4.08413975, 4.17159826, 4.25905678, 4.34651530, 4.43397381, 4.52143233, 4.60889084, 4.69634936, 4.78380787, 4.87126639, 4.95872490, 5.04618342, 5.13364193, 5.22110045, 5.30855896, 5.39601748, 5.48347600, 5.57093451, 5.65839303)
  
  # Creating background resource for full_x, using the actual slope and intercept from the linear models.
  
  # y values
  for (t in seq(1,86,1)) {
    LENS_plankton <- log10(c(small_abund[t], large_abund[t], zoo_abund[t]))
    
    # Calculate slope and intercept, expand spectra for full size range
    # Linear fits
    LENS_lm <- lm(LENS_plankton ~ plankton_x)
    
    # Expand to full size range
    # out_LENS[t,,m] <- LENS_lm$coefficients[2] * full_x + LENS_lm$coefficients[1]
    out_LENS[t,,m] <- LENS_lm$coefficients[2]*1.075 * full_x + LENS_lm$coefficients[1]*1.95
    # The scaling for the slope and intercept were determined following the method in 
    # Woodworth-Jefcoats et al. (2019)  More information is provided below.
    
    # Save slope and intercept, for diagnostics
    LENS_intercept[t,1,m] <- LENS_lm$coefficients[1]
    LENS_slope[t,1,m] <- LENS_lm$coefficients[2]

  }
  
}

# Save
save(out_LENS, file = here("ClimateForcing", "Plankton", "DataFiles",
                           "LENS_resource_spectra_S1.075I1.95.Rdata"))
save(LENS_slope, file = here("ClimateForcing", "Plankton", "DataFiles",
                             "LENS_resource_slope_S1.075I1.95.Rdata"))
save(LENS_intercept, file = here("ClimateForcing", "Plankton", "DataFiles",
                                 "LENS_resource_intercept_S1.075I1.95.Rdata"))

```

### Notes from each scaling iteration  
Because of differences across earth system models (ESMs), I've thus far found it necessary to scale the ESM output in order to obtain a realistic mizer model.  To do this, I run therMizer with all the species parameters and no plankton forcing.  I look at the resulting resource generated by the semi-chemostat model as a reference.  I also look at the behavior of the feeding level (FL) across species and sizes.  Then, I scale the slope and intercept iteratively, optimizing the feeding level to match that generated without plankton forcing.  The `projectToSteady` run is used for calibration.  I also compare modeled and observed catch, too (not shown here - see FishingForcing).  This is admittedly tedious...

When multiple ESMs are used in the same simulation round or same study, the same scaling is applied to all ESMs.

Here's what the sim plot looks like for the _mizer_ run with the simulation parameters and the semi-chemostat background resource:
![standard 5-panel mizer plot](/CalibrationSimPlot.png "Calibration Sim Plot")

Slope and intercept unscaled: steady run didn't converge, all species go extinct, background resource several orders of 
magnitude lower than calibration run, but slopes roughly comparable

Slope $\times$ 1 and intercept $\times$ 2: FL increasing with increasing size, average is comparable (~0.625), biomass comparable, predation mortality low (0.06 vs 0.12 max), background resource and species' biomass density about an order of magnitude too high
Slope $\times$ 1 and intercept $\times$ 1.75: steady run didn't converge, Blue shark go extinct.
Slope $\times$ 1 and intercept $\times$ 1.85: FL increasing with increasing size, but low (0.15 - 0.3), predation mortality closer (0.1 max), background resource close but species' biomass density a bit low.
Slope $\times$ 1 and intercept $\times$ 1.9: Similar to doubling intercept, except FL is lower (~0.375 average) 
Slope $\times$ 1 and intercept $\times$ 1.95:  Similar to doubling intercept, except FL is increases with increasing body size. Predation mortality closer (0.08 max).  Background resource and species' biomass density a bit high and slope a bit steep.
Slope $\times$ 0.95 and intercept $\times$ 1.95: Better, but FL still increases with increasing body size.
Slope $\times$ 0.75 and intercept $\times$ 1.95: Nope.  Steady run didn't converge, Skipjack go extinct.
Slope $\times$ 1.25 and intercept $\times$ 1.95: FL now decreases with body size, predation mortality high (0.12 max), slopes a bit steep.
Slope $\times$ 1.15 and intercept $\times$ 1.95: Better, less change in FL with body size, biomass densities closer 
Slope $\times$ 1.05 and intercept $\times$ 1.95: Back to FL increasing with body size, biomass densities and predation mortality closer.
Slope $\times$ 1.1 and intercept $\times$ 1.95: Similar to S1.15I1.95, but with less decrease in body size
Slope $\times$ 1.05 and intercept $\times$ 2: Closer.  FL flatter, but still increasing with body size.  Predation mortality low (0.065 max).  Biomass densities a bit high.
Slope $\times$ 1.15 and intercept $\times$ 2: FL decreasing more with increasing body size, predation mortality low and biomass densities a bit high
Slope $\times$ 1.15 and intercept $\times$ 1.9: FL too low, but predation mortality closer
Slope $\times$ 1.15 and intercept $\times$ 1.925: Everything but the FL looks good.  Still decreasing with increasing body size. 
Slope $\times$ 1.15 and intercept $\times$ 1.93: Very similar to previous run...
Slope $\times$ 1.075 and intercept $\times$ 1.95: Yes!  FL steady across body sizes, just a bit low (0.5 to 0.625), predation mortality a bit low (~0.1 max), everything else looks pretty close.  __Going with this scaling__
Slope $\times$ 1.075 and intercept $\times$ 2: Too far (FL too high, predation mortality too low, biomass densities too high)
Slope $\times$ 1.075 and intercept $\times$ 1.975: FL looks good (flat, average = 0.625), predation mortality still a little low (0.1 max) and biomass densities a bit high (but close)
Slope $\times$ 1.075 and intercept $\times$ 1.96: Even closer, for predation mortality and biomass densities
Slope $\times$ 1.075 and intercept $\times$ 1.93: Too far back the other way.

Finally, an equally valid approach would be to save the resource spectra generated by the semi-chemostat model and to scale those spectra slopes and intercepts using the change in slope and intercept generated from the ESM at each time step (rather than scaling the ESM output).  You'd probably want to do this by comparing each time step to a baseline period, as is done with temperature.